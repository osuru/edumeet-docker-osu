# Modified eduMeet in docker container

Original version - [eduMeet](https://github.com/edumeet/edumeet).
(Successor of [multiparty meeting](https://github.com/havfo/multiparty-meeting) fork of mediasoup-demo)

Whats new:
- change config to move redis inside container, nor the host
- change config to connect from server to redis via container network
- add separate TURN server and config (coturn docker with PSK auth - https://github.com/michaelfig/mediasoup-broadcast-example/tree/master/coturns)
- add API in server config.js file to manage TURN credentials via preshared key
- add getter for backupTurnServer in server config.js
- add reverse proxy support in config.js (over haproxy, if use httpOnly=true  )
- add many scripts to start/stop/restart DEV and PROD versions 
- add script for initial build app
- add script to recompile app if changed
- add custom entrypoint with logs for DEV enviroment
- add sample haproxy config for TLS frontend for edumeet and TURN shared port (require TWO dns names) 


![pic1](https://user-images.githubusercontent.com/1792184/115709704-f8357780-a38a-11eb-8722-ab7e92baa487.png)



## Run it in few easy step

1. Git clone this code to your docker machine.
2. Copy your cert in `certs/cert.pem` and `certs/privkey.pem`
    1. In case you need to generate a new cert and private key, you can use (note -nodes flag, which allows to generate unencrypted private key)

```sh
        $ openssl req -x509 -newkey rsa:4096 -keyout privkey.pem -out cert.pem -days 3650 -nodes
```

3. **Recomended**: set TURN server and credential in `configs/server/config.js` 
    1. In case using internal coturn from `docker-compose-coturn.yml` - set AUTH_KEY in coturn and first param in getter 
    `get backupTurnServers(){return [getIce(['AUTHKEY',['turn:example.ru:6444?transport=udp','turns:example.ru:443?transport=tcp'])];}`
    This example using and UDP and TLS ports to support some firewals and proxies
   in the file `docker-compose-coturn.yml` there is simple vars: 
     
     - AUTH_SECRET=exampleTURNpass
     - AUTH_REALM=example.ru
     - EXTERNAL_IP=1.1.1.1
     - TLS_DIRECTORY=/certs

If   `TLS_DIRECTORY` is empty, coturn run without TLS (for reverse proxy scenarios). For additional parametest see `configs/coturn/turnserver.conf.in`
    
    3. In case you are using external coturn, you can generate a user and key with

```sh
        $ turnadmin -k -u <username> -p <password>
```

Placeholder looks like

```js
	turnServers     : [
		{
			urls : [
				'turn:example.com:443?transport=tcp'
			],
			username   : 'example',
			credential : 'example'
		}
  ]
```

You would need to replace example.com by your IP or domain, add the username previously used `<username>` and credential is the code generated by the above mentioned command.

4. **Optional:** Change other stuff in config.js:
    1. **Optional:** replace logo/logo.svg with your company logo svg.
    2. **Optional:** sort audio/video codecs according to preference.

## Run

Run with `docker-compose` 
/ [install docker compose](https://docs.docker.com/compose/install/) /

```sh
  $ git clone https://github.com/osuru/edumeet-docker-osu
  $cd edumeet-docker-osu
  $ sudo ./complile_firsttime.sh 
  $ sudo ./start_coturn.sh
  $ sudo ./start_prod.sh
```

## Rebuild APP

If you change .env then you have to rebuild the image.

```sh
  $ sudo ./compile_recompile_app.sh
```
## Restart APP and Server without coturn and redis

```sh
  $ sudo ./restart_edumeet.sh
```

## Docker Swarm

docker stack deploy 

## Scale up

## Haproxy share port

## Custom resolver for SWARM mode only
```
resolvers docker
    nameserver dns1 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry   1s
    hold other      10s
    hold refused    10s
    hold nx         10s
    hold timeout    10s
    hold valid      10s
    hold obsolete   10s
 ```
 
## Frontend with TLS

frontend my_haproxy_ssl
 bind *:443 ssl crt /etc/ssl/haproxy.pem
 mode tcp
  option tcplog
  acl letsencrypt-acl path_beg /.well-known/acme-challenge/
  use_backend letsencrypt-backend if letsencrypt-acl
  use_backend edumeet-worker if { ssl_fc_sni  -i host-A.ru }
  use_backend edumeet-turn if { ssl_fc_sni  -i host-B.ru }


backend edumeet-worker
 mode http
 balance roundrobin
 cookie SRVNAME insert
 option forwardfor header X-Real-IP
 reqadd X-Forwarded-Proto:\ https
 server web1 127.0.0.1:5443 cookie SRV1 check #edumeet
 server web2 192.168.0.10:5443 cookie SRV2 check #edumeet

backend edumeet-turn
 mode tcp
 server turn1 62.76.152.229:6444 #turn tcp port


# Letsencrypt
## Haproxy for letsencrypt
```
frontend my_haproxy_http
 bind *:80
 mode http
  option httplog
  acl letsencrypt-acl path_beg /.well-known/acme-challenge/
  use_backend letsencrypt-backend if letsencrypt-acl
  http-request redirect scheme https if { hdr_dom(host)  -i host-A.ru } !{ ssl_fc }
  
backend letsencrypt-backend
 mode http
 server letsencrypt 127.0.0.1:8888

```

## Create certificate script
```
certbot certonly --expand --standalone -d host-A.ru, host-B.ru  \
    --non-interactive --agree-tos --email example@host.ru \
    --http-01-port=8888 \
```
## Renew script

```
#!/bin/sh
certbot renew  --tls-sni-01-port=8888 >> /var/log/letsencrypt/certbot.log
cat /etc/letsencrypt/live/host-A.ru/fullchain.pem /etc/letsencrypt/live/host-A.ru/privkey.pem > /etc/ssl/haproxy.pem
/etc/init.d/haproxy reload
```
Add in in crontab in 2:10 AM on satteday

```sh
$ crontab -e
10 2 6 * * /path-to-script/haproxy.sh

```

## Docker networking

Container `coturn` works in "host" network mode, because birdge mode has the following issue

[Docker - Docker hangs when attempting to bind a large number of ports] (https://success.docker.com/article/docker-compose-and-docker-run-hang-when-binding-a-large-port-range)

Other containers require only one port to expose for reverse proxy

